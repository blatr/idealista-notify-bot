<div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" @click.stop>
    <!-- Header -->
    <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-800">Listing Details</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div class="p-6">
        <!-- Image -->
        {% if listing.thumbnail %}
        <div class="mb-4">
            <img src="{{ listing.thumbnail }}"
                 alt="{{ listing.title }}"
                 class="w-full h-64 object-cover rounded-lg"
                 onerror="this.style.display='none'">
        </div>
        {% endif %}

        <!-- Title and Price -->
        <div class="mb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-2">{{ listing.title }}</h3>
            <p class="text-2xl font-bold text-green-600">{{ listing.price or 'N/A' }}</p>
        </div>

        <!-- Details Grid -->
        <div class="grid grid-cols-3 gap-4 mb-4">
            <div class="bg-gray-50 p-3 rounded text-center">
                <p class="text-gray-500 text-xs mb-1">Rooms</p>
                <p class="font-semibold">{{ listing.rooms or '-' }}</p>
            </div>
            <div class="bg-gray-50 p-3 rounded text-center">
                <p class="text-gray-500 text-xs mb-1">Size</p>
                <p class="font-semibold">{{ listing.size or '-' }}</p>
            </div>
            <div class="bg-gray-50 p-3 rounded text-center">
                <p class="text-gray-500 text-xs mb-1">Floor</p>
                <p class="font-semibold">{{ listing.floor or '-' }}</p>
            </div>
        </div>

        <!-- Telephone -->
        <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Telephone</h4>
            <div class="flex gap-2">
                <input type="text" id="telephone-{{ listing.id }}"
                       class="flex-1 border rounded px-3 py-2"
                       placeholder="Enter phone number"
                       value="{{ listing.telephone or '' }}">
                <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                        onclick="(function() {
                            var telephone = document.getElementById('telephone-{{ listing.id }}').value;
                            fetch('{{ base_url }}/api/listings/{{ listing.id }}', {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({telephone: telephone})
                            }).then(function(r) {
                                if (r.ok) { showToast('Telephone saved!'); }
                                else { showToast('Error saving telephone', 'error'); }
                            }).catch(function() { showToast('Network error', 'error'); });
                        })()">
                    Save
                </button>
            </div>
        </div>

        <!-- Description -->
        {% if listing.description %}
        <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Description</h4>
            <p class="text-gray-600 text-sm whitespace-pre-line">{{ listing.description }}</p>
        </div>
        {% endif %}

        <!-- Stage Selector -->
        <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Stage</h4>
            <select id="stage-select-{{ listing.id }}"
                    class="w-full border rounded px-3 py-2"
                    onchange="(function(el) {
                        fetch('{{ base_url }}/api/listings/{{ listing.id }}/stage', {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({stage: el.value})
                        }).then(function(r) {
                            if (r.ok) { location.reload(); }
                            else { showToast('Error updating stage', 'error'); }
                        });
                    })(this)">
                {% for stage in stages %}
                <option value="{{ stage.value }}" {% if listing.stage == stage.value %}selected{% endif %}>
                    {{ stage.label }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Priority Selector -->
        <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Priority ({{ listing.priority or 0 }})</h4>
            <div class="flex flex-wrap gap-1">
                {% for p in range(11) %}
                <button type="button"
                        class="w-8 h-8 rounded text-xs font-bold transition-all
                            {% if p == (listing.priority or 0) %}ring-2 ring-offset-1 ring-gray-800{% endif %}
                            {% if p == 0 %}bg-gray-200 text-gray-600 hover:bg-gray-300
                            {% elif p <= 2 %}bg-gray-300 text-gray-700 hover:bg-gray-400
                            {% elif p <= 4 %}bg-green-400 text-gray-800 hover:bg-green-500
                            {% elif p <= 6 %}bg-yellow-400 text-gray-800 hover:bg-yellow-500
                            {% elif p <= 8 %}bg-orange-500 text-white hover:bg-orange-600
                            {% else %}bg-red-500 text-white hover:bg-red-600{% endif %}"
                        onclick="(function() {
                            fetch('{{ base_url }}/api/listings/{{ listing.id }}', {
                                method: 'PUT',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({priority: {{ p }}})
                            }).then(function(r) {
                                if (r.ok) { location.reload(); }
                                else { showToast('Error updating priority', 'error'); }
                            });
                        })()">
                    {{ p }}
                </button>
                {% endfor %}
            </div>
            <p class="text-xs text-gray-400 mt-1">0 = no priority, 10 = highest priority</p>
        </div>

        <!-- Notes -->
        <div class="mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Notes</h4>
            <textarea id="notes-{{ listing.id }}"
                      class="w-full border rounded px-3 py-2 h-24 resize-none"
                      placeholder="Add your notes here...">{{ listing.notes or '' }}</textarea>
            <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"
                    onclick="(function() {
                        var notes = document.getElementById('notes-{{ listing.id }}').value;
                        fetch('{{ base_url }}/api/listings/{{ listing.id }}', {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({notes: notes})
                        }).then(function(r) {
                            if (r.ok) { showToast('Notes saved!'); }
                            else { showToast('Error saving notes', 'error'); }
                        }).catch(function() { showToast('Network error', 'error'); });
                    })()">
                Save Notes
            </button>
        </div>

        <!-- Idealista Link -->
        {% if listing.idealista_url %}
        <div class="mb-4">
            <a href="{{ listing.idealista_url }}"
               target="_blank"
               class="text-blue-500 hover:underline text-sm flex items-center gap-1"
               onclick="event.stopPropagation()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
                View on Idealista
            </a>
        </div>
        {% endif %}

        <!-- Meta Info -->
        <div class="text-xs text-gray-400 border-t pt-4 mt-4">
            <p>Source: {{ listing.source }}</p>
            <p>Created: {{ listing.created_at.strftime('%Y-%m-%d %H:%M') if listing.created_at else 'N/A' }}</p>
        </div>
    </div>

    <!-- Footer Actions -->
    <div class="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex justify-between">
        <button class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
                onclick="if(confirm('Are you sure you want to delete this listing?')) {
                    fetch('{{ base_url }}/api/listings/{{ listing.id }}', {method: 'DELETE'})
                    .then(function(r) {
                        if (r.ok) { closeModal(); location.reload(); }
                        else { showToast('Error deleting', 'error'); }
                    });
                }">
            Delete
        </button>
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
            Close
        </button>
    </div>
</div>
